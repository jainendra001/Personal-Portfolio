<!DOCTYPE html>
<html lang="vi">

<head>
    <title>Game x·∫øp h√¨nh</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- Th√™m CSS cho l·ª±a ch·ªçn ch·∫ø ƒë·ªô --- */
        .game-mode-selection {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }

        .game-mode-selection label {
            margin-right: 15px;
            margin-left: 5px;
            cursor: pointer;
        }

        .game-mode-selection input[type="radio"] {
            cursor: pointer;
        }

        #countdown-duration-group {
            display: inline-flex;
            /* S·ª≠ d·ª•ng flex ƒë·ªÉ cƒÉn ch·ªânh t·ªët h∆°n */
            align-items: center;
            /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            margin-left: 10px;
            vertical-align: middle;
        }

        #countdown-duration-group label {
            margin-right: 5px;
            font-size: 0.9em;
            margin-bottom: 0;
            /* B·ªè margin bottom m·∫∑c ƒë·ªãnh c·ªßa label */
        }

        /* Style cho thanh tr∆∞·ª£t */
        #countdown-seconds.custom-range {
            width: auto;
            /* Cho ph√©p co gi√£n */
            max-width: 150px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
            vertical-align: middle;
            /* CƒÉn gi·ªØa */
            margin: 0 5px;
            /* Kho·∫£ng c√°ch hai b√™n */
            cursor: pointer;
        }

        #countdown-value {
            font-weight: bold;
            min-width: 20px;
            /* ƒê·∫£m b·∫£o c√≥ ƒë·ªß ch·ªó cho s·ªë 2 ch·ªØ s·ªë */
            display: inline-block;
            text-align: right;
            /* CƒÉn ph·∫£i s·ªë */
        }

        /* --- Th√™m CSS cho tr·∫°ng th√°i thua --- */
        #game-table.game-lost {
            border: 3px solid #dc3545;
            /* M√†u ƒë·ªè Bootstrap */
            box-shadow: 0 0 15px #dc3545;
        }

        #game-table.game-lost .image-cell {
            border-color: #dc3545;
            opacity: 0.7;
            /* H∆°i m·ªù ƒëi */
        }

        #game-table.game-lost img {
            cursor: not-allowed !important;
            /* Con tr·ªè kh√¥ng cho ph√©p */
        }
    </style>
</head>

<body>
    <!-- ===== NAVBAR START (Custom CSS) ===== -->
    <nav class="custom-navbar">
        <div class="nav-container">
            <a class="nav-brand" href="index.html">
                <img style="max-height: 40px; display: inline-block; vertical-align: middle;" src="logo.png" alt="Logo">
                <!-- Optional: Th√™m t√™n th∆∞∆°ng hi·ªáu d·∫°ng text -->
                <!-- <span style="vertical-align: middle; margin-left: 5px;">Game X·∫øp H√¨nh</span> -->
            </a>

            <button class="nav-toggler" id="navbarToggler" aria-label="Toggle navigation">
                <span class="nav-toggler-icon"></span>
            </button>

            <div class="nav-collapse" id="navbarNavContent">
                <ul class="nav-menu">
                    <li class="nav-menu-item ">
                        <a class="nav-menu-link" href="index.html">Trang Ch·ªß <span
                                class="screen-reader-only">(current)</span></a>
                    </li>
                    <li class="nav-menu-item active">
                        <a class="nav-menu-link" href="game.html">Ch∆°i Game</a>
                    </li>
                    <li class="nav-menu-item">
                        <a class="nav-menu-link" href="about.html">Gi·ªõi Thi·ªáu</a>
                    </li>
                    <li class="nav-menu-item">
                        <a class="nav-menu-link" href="contact.html">Li√™n H·ªá</a>
                    </li>
                    <li class="nav-menu-item">
                        <a class="nav-menu-link" href="split.html">C·∫Øt ·∫¢nh</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- ===== NAVBAR END (Custom CSS) ===== -->

    <div class="game-title-area">
        <h1>Game X·∫øp H√¨nh</h1>
        <h6>Click v√†o ·∫£nh ƒë·ªÉ xoay g√≥c ƒë·ªô c·ªßa ·∫£nh. K√©o th·∫£ ·∫£nh v√†o ƒë√∫ng v·ªã tr√≠.</h6>
    </div>

    <!-- ===== L·ª∞A CH·ªåN CH·∫æ ƒê·ªò CH∆†I (C·∫≠p nh·∫≠t) ===== -->
    <div class="game-mode-selection">
        <strong>Ch·∫ø ƒë·ªô ch∆°i:</strong>
        <input type="radio" id="mode-classic" name="gameMode" value="classic" checked>
        <label for="mode-classic">C·ªï ƒëi·ªÉn (ƒê·∫øm l√™n)</label>

        <input type="radio" id="mode-countdown" name="gameMode" value="countdown">
        <label for="mode-countdown">ƒê·∫øm ng∆∞·ª£c</label>

        <div id="countdown-duration-group" style="display: none;"> <!-- ·∫®n ban ƒë·∫ßu -->
            <label for="countdown-seconds">Gi√¢y:</label>
            <!-- S·ª≠ d·ª•ng thanh tr∆∞·ª£t (range input) -->
            <input type="range" id="countdown-seconds" class="custom-range" value="30" min="20" max="60" step="5">
            <span id="countdown-value" style="font-weight: bold; margin-left: 5px;">30</span> gi√¢y
            <!-- Ho·∫∑c d√πng input number:
         <input type="number" id="countdown-seconds" class="form-control d-inline-block" style="max-width: 70px;" value="45" min="20" max="60" step="5"> gi√¢y
         -->
        </div>
    </div>
    <!-- ================================== -->


    <div class="game-container">
        <!-- Khu v·ª±c ·∫£nh tham chi·∫øu b√™n tr√°i -->
        <div class="reference-section">
            <h5>·∫¢nh G·ªëc</h5>
            <!-- ·∫¢nh g·ªëc m·∫∑c ƒë·ªãnh (Paimon) -->
            <img src="AnhXepHinh/paimon/Genshin_Impact.jpg" alt="·∫¢nh g·ªëc tham kh·∫£o" class="reference-image">
        </div>

        <!-- Khu v·ª±c ch∆°i game ch√≠nh gi·ªØa -->
        <div class="main-game-section">
            <div id="timer-display">Th·ªùi gian: 00:00</div>
            <div id="game-table">
                <!-- 9 √¥ m·ª•c ti√™u 3x3 -->
                <div class="image-cell target-cell" id="cell-0" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-1" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-2" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-3" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-4" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-5" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-6" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-7" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-8" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
            </div>
        </div>

        <!-- Khu v·ª±c danh s√°ch ·∫£nh ngu·ªìn -->
        <div id="image-list-container">
            <h5>C√°c M·∫£nh Gh√©p</h5>
            <div id="image-list">
                <!-- C√°c √¥ ·∫£nh ngu·ªìn m·∫∑c ƒë·ªãnh (Paimon) - S·∫Ω ƒë∆∞·ª£c shuffle b·ªüi JS -->
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-1.jpg" id="paimon-image01" data-correct-cell="cell-0"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-2.jpg" id="paimon-image02" data-correct-cell="cell-1"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-3.jpg" id="paimon-image03" data-correct-cell="cell-2"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-4.jpg" id="paimon-image04" data-correct-cell="cell-3"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-5.jpg" id="paimon-image05" data-correct-cell="cell-4"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-6.jpg" id="paimon-image06" data-correct-cell="cell-5"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-7.jpg" id="paimon-image07" data-correct-cell="cell-6"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-8.jpg" id="paimon-image08" data-correct-cell="cell-7"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-9.jpg" id="paimon-image09" data-correct-cell="cell-8"
                        draggable="true" />
                </div>
            </div>
        </div>

    </div><!-- End .game-container -->

    <!-- Khu v·ª±c ch·ªçn ·∫£nh m·ªõi -->
    <div id="puzzle-selection">
        <h4 style="border-top: 1px solid #eee; padding: 20px; margin-left: 50px;">Ch·ªçn ·∫¢nh Kh√°c</h4>
        <div id="selection-list">
            <!-- Danh s√°ch ·∫£nh l·ª±a ch·ªçn s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
        </div>
    </div>

    <!-- ===== FOOTER START ===== -->
    <footer class="site-footer"> <!-- B·ªè mt-5 n·∫øu d√πng flexbox cho body -->
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="copyright-text mb-2">
                        ¬© 2024 Game X·∫øp H√¨nh Vui Nh·ªôn. Ph√°t tri·ªÉn b·ªüi Tr√†n H·ªØu ƒê·∫°t.
                    </p>
                    <p class="footer-links mb-1">
                        <a href="index.html">Trang Ch·ªß</a> |
                        <a href="game.html">Ch∆°i Game</a> |
                        <a href="about.html">Gi·ªõi Thi·ªáu</a> |
                        <a href="contact.html">Li√™n H·ªá</a> |
                        <a href="split.html">C·∫Øt ·∫¢nh</a>
                    </p>
                    <p class="made-with">
                        <small>ƒê∆∞·ª£c x√¢y d·ª±ng v·ªõi <i class="text-danger">‚ô•</i> v√† Bootstrap, jQuery.</small>
                    </p>
                </div>
            </div>
        </div>
    </footer>
    <!-- ===== FOOTER END ===== -->

    <!-- Modal th√¥ng b√°o chi·∫øn th·∫Øng -->
    <div class="modal fade" id="winModal" tabindex="-1" role="dialog" aria-labelledby="winModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="winModalLabel">üéâ Ch√∫c M·ª´ng! üéâ</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">√ó</span>
                    </button>
                </div>
                <div class="modal-body">
                    B·∫°n ƒë√£ ho√†n th√†nh b·ª©c tranh! <br>
                    Th·ªùi gian c·ªßa b·∫°n l√†: <strong id="final-time"></strong>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="location.reload()">Ch∆°i L·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL TH√îNG B√ÅO THUA CU·ªòC ===== -->
    <div class="modal fade" id="loseModal" tabindex="-1" role="dialog" aria-labelledby="loseModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="loseModalLabel"> R·∫•t Ti·∫øc! ƒê√£ H·∫øt Gi·ªù</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">√ó</span>
                    </button>
                </div>
                <div class="modal-body">
                    B·∫°n ƒë√£ kh√¥ng ho√†n th√†nh b·ª©c tranh trong th·ªùi gian quy ƒë·ªãnh.
                    <br>
                    H√£y c·ªë g·∫Øng h∆°n ·ªü l·∫ßn ch∆°i sau nh√©!
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="resetGame()">Ch∆°i L·∫°i</button>
                    <!-- onclick g·ªçi h√†m reset m·ªõi thay v√¨ reload -->
                </div>
            </div>
        </div>
    </div>
    <!-- ==================================== -->

    <!-- Scripts (jQuery, Popper, Bootstrap) gi·ªØ nguy√™n -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Custom Game JavaScript (C·∫≠p nh·∫≠t) -->
    <script>
        // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ---
        let timerInterval = null;
        let startTime = null;     // D√πng cho ch·∫ø ƒë·ªô classic
        let timerSecondsRemaining = 0; // D√πng cho ch·∫ø ƒë·ªô countdown
        let countdownDuration = 30; // *** THAY ƒê·ªîI: Gi√° tr·ªã m·∫∑c ƒë·ªãnh theo gi√¢y ***
        let timerRunning = false;
        let gameWon = false;
        let timeUp = false;      // C·ªù m·ªõi cho tr·∫°ng th√°i h·∫øt gi·ªù
        let draggedElement = null;
        let currentPuzzleId = 'paimon';
        let gameMode = 'classic'; // Ch·∫ø ƒë·ªô ch∆°i m·∫∑c ƒë·ªãnh

        // --- D·ªØ li·ªáu c√°c b·ªô ·∫£nh ---
        const puzzlesData = {
            'paimon': {
                name: 'Paimon',
                // !!! KI·ªÇM TRA V√Ä THAY ƒê·ªîI ƒê∆Ø·ªúNG D·∫™N CHO ƒê√öNG !!!
                reference: 'AnhXepHinh/paimon/Genshin_Impact.jpg',
                pieces: [
                    'AnhXepHinh/paimon/anh-1.jpg', 'AnhXepHinh/paimon/anh-2.jpg', 'AnhXepHinh/paimon/anh-3.jpg',
                    'AnhXepHinh/paimon/anh-4.jpg', 'AnhXepHinh/paimon/anh-5.jpg', 'AnhXepHinh/paimon/anh-6.jpg',
                    'AnhXepHinh/paimon/anh-7.jpg', 'AnhXepHinh/paimon/anh-8.jpg', 'AnhXepHinh/paimon/anh-9.jpg'
                ],
                thumbnail: 'AnhXepHinh/paimon/Genshin_Impact.jpg'
            },
            'honkai_star_rail': {
                name: 'Honkai Star Rail',
                // !!! KI·ªÇM TRA V√Ä THAY ƒê·ªîI ƒê∆Ø·ªúNG D·∫™N CHO ƒê√öNG !!!
                reference: 'AnhXepHinh/honkai_star_rail/Honkai_Star_Rail.png',
                pieces: [
                    'AnhXepHinh/honkai_star_rail/anh-1.jpg', 'AnhXepHinh/honkai_star_rail/anh-2.jpg', 'AnhXepHinh/honkai_star_rail/anh-3.jpg',
                    'AnhXepHinh/honkai_star_rail/anh-4.jpg', 'AnhXepHinh/honkai_star_rail/anh-5.jpg', 'AnhXepHinh/honkai_star_rail/anh-6.jpg',
                    'AnhXepHinh/honkai_star_rail/anh-7.jpg', 'AnhXepHinh/honkai_star_rail/anh-8.jpg', 'AnhXepHinh/honkai_star_rail/anh-9.jpg'
                ],
                thumbnail: 'AnhXepHinh/honkai_star_rail/Honkai_Star_Rail.png'
            },
            'zenless_zone_zero': {
                name: 'Zenless Zone Zero',
                // !!! KI·ªÇM TRA V√Ä THAY ƒê·ªîI ƒê∆Ø·ªúNG D·∫™N CHO ƒê√öNG !!!
                reference: 'AnhXepHinh/zenless_zone_zero/zenless-zone-zero.jpg',
                pieces: [
                    'AnhXepHinh/zenless_zone_zero/anh-1.jpg', 'AnhXepHinh/zenless_zone_zero/anh-2.jpg', 'AnhXepHinh/zenless_zone_zero/anh-3.jpg',
                    'AnhXepHinh/zenless_zone_zero/anh-4.jpg', 'AnhXepHinh/zenless_zone_zero/anh-5.jpg', 'AnhXepHinh/zenless_zone_zero/anh-6.jpg',
                    'AnhXepHinh/zenless_zone_zero/anh-7.jpg', 'AnhXepHinh/zenless_zone_zero/anh-8.jpg', 'AnhXepHinh/zenless_zone_zero/anh-9.jpg'
                ],
                thumbnail: 'AnhXepHinh/zenless_zone_zero/zenless-zone-zero.jpg'
            }
            // Th√™m c√°c b·ªô ·∫£nh kh√°c v√†o ƒë√¢y
        };

        // --- C√°c h√†m x·ª≠ l√Ω th·ªùi gian ---
        function startTimer() {
            if (timerRunning || gameWon || timeUp) return;
            timerRunning = true;
            if (gameMode === 'classic') {
                startTime = Date.now();
                timerInterval = setInterval(updateClassicTimer, 1000);
                updateClassicTimer();
                console.log('Classic Timer started');
            } else if (gameMode === 'countdown') {
                timerSecondsRemaining = countdownDuration;
                timerInterval = setInterval(updateCountdownTimer, 1000);
                updateCountdownTimer();
                console.log(`Countdown Timer started (${countdownDuration}s)`);
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerRunning = false;
            console.log('Timer stopped');
        }

        function updateClassicTimer() {
            if (!startTime) return;
            const elapsedTime = Date.now() - startTime;
            displayTime(elapsedTime / 1000);
        }

        function updateCountdownTimer() {
            if (timerSecondsRemaining <= 0 || gameWon) {
                if (timerSecondsRemaining <= 0 && !gameWon) {
                    handleTimeUp();
                } else {
                    stopTimer();
                }
                return;
            }
            timerSecondsRemaining--;
            displayTime(timerSecondsRemaining);
        }

        function displayTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            $('#timer-display').text(`Th·ªùi gian: ${formattedTime}`);
        }

        function handleTimeUp() {
            console.log("Time's Up!");
            timeUp = true;
            stopTimer();
            $('#game-table').addClass('game-lost').removeClass('game-won');
            $('#game-table img, #image-list img').attr('draggable', false).css('cursor', 'not-allowed');
            $('#loseModal').modal('show');
        }


        // --- H√†m ki·ªÉm tra ƒëi·ªÅu ki·ªán th·∫Øng ---
        function checkWinCondition() {
            if (gameWon || timeUp) return false;
            const targetCells = $('#game-table .target-cell');
            if (targetCells.length !== 9) return false;
            let allCorrect = true;
            for (let i = 0; i < targetCells.length; i++) {
                const cell = targetCells[i];
                const img = cell.querySelector('img');
                if (!img) { allCorrect = false; break; }
                const expectedCellId = img.getAttribute('data-correct-cell');
                const currentCellId = cell.id;
                const currentAngle = ($(img).data('angle') || 0) % 360;
                if (expectedCellId !== currentCellId || currentAngle !== 0) {
                    allCorrect = false;
                    break;
                }
            }
            if (allCorrect) {
                console.log('Game Won!');
                gameWon = true;
                timeUp = false;
                stopTimer();
                $('#game-table').addClass('game-won').removeClass('game-lost');
                $('#game-table img, #image-list img').attr('draggable', false).css('cursor', 'default');
                if (gameMode === 'classic') {
                    $('#final-time').text(getFinalTime());
                } else {
                    const usedSeconds = countdownDuration - timerSecondsRemaining;
                    const minutes = Math.floor(usedSeconds / 60);
                    const seconds = Math.floor(usedSeconds % 60);
                    $('#final-time').text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
                }
                $('#winModal').modal('show');
            }
            return allCorrect;
        }

        // --- H√†m x√°o tr·ªôn ---
        function shuffleImages() {
            var parent = $("#image-list");
            var cells = parent.children('.source-cell');
            if (cells.length === 0) return;

            var tempCells = [];
            cells.each(function () {
                tempCells.push($(this).detach());
            });

            while (tempCells.length) {
                parent.append(tempCells.splice(Math.floor(Math.random() * tempCells.length), 1)[0]);
            }

            parent.find('.source-cell img').each(function () {
                var randomRotation = getRandomRotationAngle();
                $(this).css('transform', 'rotate(' + randomRotation + 'deg)');
                $(this).data('angle', randomRotation);
            });
            console.log("Shuffled images for:", currentPuzzleId);
        }

        // --- H√†m l·∫•y g√≥c xoay ng·∫´u nhi√™n ---
        function getRandomRotationAngle() {
            var angles = [0, 90, 180, 270];
            return angles[Math.floor(Math.random() * angles.length)];
        }


        // --- C√°c h√†m x·ª≠ l√Ω Drag and Drop ---
        function startDrag(event) {
            if (gameWon || timeUp) { event.preventDefault(); return; }
            draggedElement = event.target;
            event.dataTransfer.setData('imageId', draggedElement.id);
            setTimeout(() => {
                if (draggedElement) draggedElement.classList.add('dragging');
            }, 0);
        }

        function allowDrop(event, receiverCell) {
            if (gameWon || timeUp) return;
            const isReceiverEmpty = receiverCell.childElementCount === 0;
            const isNotSelfContainer = draggedElement ? receiverCell !== draggedElement.parentNode : true;
            if (isReceiverEmpty && isNotSelfContainer) {
                event.preventDefault();
                receiverCell.classList.add('drag-over-valid');
            }
        }

        function dragLeave(event, receiverCell) {
            if (receiverCell) receiverCell.classList.remove('drag-over-valid');
        }

        function endDrag(event) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            $('.image-cell').removeClass('drag-over-valid');
            draggedElement = null;
        }

        function receiveData(event) {
            event.preventDefault();
            if (gameWon || timeUp) return;

            const id = event.dataTransfer.getData('imageId');
            const droppedImage = document.getElementById(id);
            let targetCell = event.target;

            $('.image-cell').removeClass('drag-over-valid');

            if (!droppedImage) return;

            if (targetCell.tagName === 'IMG') {
                targetCell = targetCell.parentNode;
            }

            if (targetCell.classList.contains('image-cell') &&
                targetCell.childElementCount === 0 &&
                (!draggedElement || targetCell !== draggedElement.parentNode)) {
                targetCell.appendChild(droppedImage);

                if ($(targetCell).closest('#game-table').length > 0 && !timerRunning) {
                    console.log("ƒêi·ªÅu ki·ªán b·∫Øt ƒë·∫ßu timer th·ªèa m√£n");
                    startTimer();
                }
                if ($(targetCell).closest('#game-table').length > 0) {
                    checkWinCondition();
                }
            }
        }

        // --- H√†m t·∫°o danh s√°ch l·ª±a ch·ªçn ·∫£nh ---
        function populateSelectionList() {
            const selectionList = $('#selection-list');
            selectionList.empty();

            for (const puzzleId in puzzlesData) {
                const puzzle = puzzlesData[puzzleId];
                const imgElement = $('<img>')
                    .attr('src', puzzle.thumbnail)
                    .attr('alt', `Ch·ªçn ${puzzle.name}`)
                    .attr('data-puzzle-id', puzzleId)
                    .addClass('puzzle-option img-thumbnail')
                    .on('click', selectPuzzle); // G√°n s·ª± ki·ªán

                if (puzzleId === currentPuzzleId) {
                    imgElement.addClass('active');
                }
                selectionList.append(imgElement);
            }
        }

        // --- H√†m x·ª≠ l√Ω khi ch·ªçn b·ªô ·∫£nh m·ªõi ---
        function selectPuzzle(event) {
            const selectedId = $(event.target).data('puzzle-id');
            if (selectedId === currentPuzzleId) return;
            currentPuzzleId = selectedId;
            $('.puzzle-option').removeClass('active');
            $(event.target).addClass('active');
            // G·ªçi h√†m reset t·ªïng qu√°t
            resetGame();
        }

        // --- H√†m Reset v√† T·∫£i b·ªô ·∫£nh m·ªõi ---
        function resetAndLoadPuzzle(puzzleId) {
            console.log("ƒêang t·∫£i b·ªô ·∫£nh:", puzzleId);
            const puzzle = puzzlesData[puzzleId];
            if (!puzzle) { console.error("Kh√¥ng t√¨m th·∫•y b·ªô ·∫£nh:", puzzleId); return; }

            // 1. Reset b·∫£ng ch∆°i v√† tr·∫°ng th√°i tr·ª±c quan
            $('#game-table').removeClass('game-won game-lost');
            $('#game-table .target-cell').empty();

            // 2. Update ·∫£nh g·ªëc
            $('.reference-image').attr('src', puzzle.reference).attr('alt', `·∫¢nh g·ªëc ${puzzle.name}`);

            // 3. T·∫°o m·∫£nh gh√©p m·ªõi
            const imageList = $('#image-list');
            imageList.empty();

            if (!puzzle.pieces || puzzle.pieces.length !== 9) {
                console.error("D·ªØ li·ªáu m·∫£nh gh√©p kh√¥ng h·ª£p l·ªá cho:", puzzleId);
                imageList.html('<p style="color: red;">L·ªói t·∫£i m·∫£nh gh√©p!</p>');
                return;
            }

            puzzle.pieces.forEach((pieceSrc, index) => {
                const cellId = `cell-${index}`;
                const imgId = `${puzzleId}-image${String(index + 1).padStart(2, '0')}`;

                // T·∫°o ·∫£nh v√† l·∫•y DOM element
                const imgDOM = $('<img>')
                    .attr('src', pieceSrc)
                    .attr('id', imgId)
                    .attr('data-correct-cell', cellId)
                    .get(0);

                // G√°n thu·ªôc t√≠nh v√† s·ª± ki·ªán tr·ª±c ti·∫øp
                imgDOM.draggable = true; // K√≠ch ho·∫°t l·∫°i draggable
                imgDOM.ondragstart = startDrag;
                imgDOM.ondragend = endDrag;

                // T·∫°o √¥ ch·ª©a v√† l·∫•y DOM element
                const cellDOM = $('<div>')
                    .addClass('image-cell source-cell')
                    .append(imgDOM)
                    .get(0);

                // G√°n s·ª± ki·ªán tr·ª±c ti·∫øp cho √¥ ch·ª©a
                cellDOM.ondragover = (e) => allowDrop(e, cellDOM);
                cellDOM.ondrop = (e) => receiveData(e);
                cellDOM.ondragleave = (e) => dragLeave(e, cellDOM);

                imageList.append(cellDOM);
            });

            // 4. X√°o tr·ªôn c√°c m·∫£nh m·ªõi
            shuffleImages();

            // 5. ƒê·∫£m b·∫£o cursor ƒë√∫ng
            $('#image-list img').css('cursor', 'grab');

            console.log("ƒê√£ t·∫£i xong b·ªô ·∫£nh:", puzzleId);
        }

        // --- H√†m Reset Game T·ªïng Qu√°t (*** C·∫¨P NH·∫¨T ***) ---
        function resetGame() {
            console.log("Resetting game...");
            // 1. Reset c√°c c·ªù tr·∫°ng th√°i (gi·ªØ nguy√™n)
            gameWon = false;
            timeUp = false;
            timerRunning = false;
            draggedElement = null;

            // 2. D·ª´ng timer hi·ªán t·∫°i (gi·ªØ nguy√™n)
            stopTimer();
            startTime = null;
            timerSecondsRemaining = 0;

            // 3. ƒê·∫∑t l·∫°i hi·ªÉn th·ªã timer d·ª±a tr√™n ch·∫ø ƒë·ªô hi·ªán t·∫°i (*** C·∫¨P NH·∫¨T ***)
            if (gameMode === 'classic') {
                $('#timer-display').text('Th·ªùi gian: 00:00');
            } else {
                // *** THAY ƒê·ªîI: L·∫•y gi√° tr·ªã t·ª´ input gi√¢y ***
                let secondsValue = parseInt($('#countdown-seconds').val()) || 45; // L·∫•y gi√° tr·ªã gi√¢y, m·∫∑c ƒë·ªãnh 45
                // ƒê·∫£m b·∫£o gi√° tr·ªã n·∫±m trong kho·∫£ng min-max (ph√≤ng tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng s·ª≠a HTML)
                secondsValue = Math.max(20, Math.min(60, secondsValue));
                countdownDuration = secondsValue; // C·∫≠p nh·∫≠t duration (gi√¢y)
                timerSecondsRemaining = countdownDuration;
                displayTime(timerSecondsRemaining); // Hi·ªÉn th·ªã th·ªùi gian countdown ban ƒë·∫ßu
                // C·∫≠p nh·∫≠t c·∫£ span hi·ªÉn th·ªã gi√° tr·ªã
                $('#countdown-value').text(countdownDuration);
            }

            // 4. T·∫£i l·∫°i c√°c m·∫£nh gh√©p (gi·ªØ nguy√™n)
            resetAndLoadPuzzle(currentPuzzleId);
        }


        // --- Document Ready ---
        $(document).ready(function () {
            // G√°n s·ª± ki·ªán cho c√°c ·∫£nh/√¥ ban ƒë·∫ßu c√≥ trong HTML
            $('#image-list img').each(function () {
                const imgDOM = $(this).get(0);
                // Ch·ªâ g√°n n·∫øu ch∆∞a c√≥ listener (tr√°nh g√°n nhi·ªÅu l·∫ßn khi s·ª≠a code)
                if (!imgDOM.ondragstart) imgDOM.ondragstart = startDrag;
                if (!imgDOM.ondragend) imgDOM.ondragend = endDrag;
            });
            $('#image-list .source-cell').each(function () {
                const cellDOM = $(this).get(0);
                if (!cellDOM.ondragover) cellDOM.ondragover = (e) => allowDrop(e, cellDOM);
                if (!cellDOM.ondrop) cellDOM.ondrop = (e) => receiveData(e);
                if (!cellDOM.ondragleave) cellDOM.ondragleave = (e) => dragLeave(e, cellDOM);
            });

            // Hi·ªÉn th·ªã danh s√°ch ch·ªçn
            populateSelectionList();

            // X√°o tr·ªôn b·ªô ·∫£nh m·∫∑c ƒë·ªãnh
            shuffleImages();

            // X·ª≠ l√Ω thay ƒë·ªïi ch·∫ø ƒë·ªô ch∆°i
            $('input[name="gameMode"]').change(function () {
                gameMode = $(this).val();
                console.log("Ch·∫ø ƒë·ªô ch∆°i ƒë·ªïi th√†nh:", gameMode);
                if (gameMode === 'countdown') {
                    $('#countdown-duration-group').slideDown();
                } else {
                    $('#countdown-duration-group').slideUp();
                }
                resetGame(); // Reset khi ƒë·ªïi ch·∫ø ƒë·ªô
            });

            // *** TH√äM: X·ª≠ l√Ω thay ƒë·ªïi gi√° tr·ªã thanh tr∆∞·ª£t ***
            $('#countdown-seconds').on('input', function () {
                // C·∫≠p nh·∫≠t span hi·ªÉn th·ªã gi√° tr·ªã ngay l·∫≠p t·ª©c
                $('#countdown-value').text($(this).val());
                // C√≥ th·ªÉ reset game ngay khi k√©o ƒë·ªÉ √°p d·ª•ng, ho·∫∑c ch·ªâ reset khi ng∆∞·ªùi d√πng th·∫£ chu·ªôt
                // ho·∫∑c khi b·∫Øt ƒë·∫ßu game m·ªõi (hi·ªán t·∫°i ƒëang reset khi ƒë·ªïi ch·∫ø ƒë·ªô ho·∫∑c ch·ªçn ·∫£nh m·ªõi)
                // N·∫øu mu·ªën reset ngay khi k√©o xong:
                // clearTimeout(resetTimeout); // X√≥a timeout c≈© n·∫øu c√≥
                // resetTimeout = setTimeout(resetGame, 500); // Reset sau 0.5s kh√¥ng k√©o n·ªØa
            });

            // *** THAY ƒê·ªîI: Ch·ªâ reset khi ng∆∞·ªùi d√πng thay ƒë·ªïi h·∫≥n gi√° tr·ªã (sau khi th·∫£ chu·ªôt ho·∫∑c nh·∫≠p xong) ***
            $('#countdown-seconds').on('change', function () {
                if (gameMode === 'countdown') {
                    console.log("Countdown duration changed, resetting game.");
                    resetGame(); // Reset khi ƒë·ªïi th·ªùi gian xong
                }
            });


        }); // K·∫øt th√∫c $(document).ready()

        // --- S·ª∞ KI·ªÜN CLICK XOAY ·∫¢NH (D√πng event delegation) ---
        $(document).on('click', '.image-cell img', function (e) {
            if (gameWon || timeUp) return; // Ki·ªÉm tra c·∫£ th·∫Øng v√† h·∫øt gi·ªù
            if ($(this).hasClass('dragging')) return;

            var currentAngle = ($(this).data('angle') || 0);
            var newAngle = (currentAngle + 90) % 360;
            $(this).css('transform', 'rotate(' + newAngle + 'deg)');
            $(this).data('angle', newAngle);

            if ($(this).closest('#game-table').length > 0) {
                checkWinCondition();
            }
        });

    </script>

</body>

</html>