<!DOCTYPE html>
<html lang="vi">

<head>
    <title>Game x·∫øp h√¨nh</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            padding-top: 20px;
            font-family: sans-serif;
            /* ƒê·ªÉ tr√°nh modal che khu v·ª±c ch·ªçn ·∫£nh */
        }

        .game-title-area {
            text-align: center;
            margin-top: 80px;
            margin-bottom: 20px;
        }

        .game-title-area h1 {
            margin-bottom: 5px;
        }

        .game-title-area h6 {
            color: #555;
            font-size: 0.9em;
        }

        /* Container ch√≠nh */
        .game-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
            /* Kho·∫£ng c√°ch v·ªõi khu v·ª±c ch·ªçn ·∫£nh */
        }

        /* Khu v·ª±c ·∫£nh tham chi·∫øu */
        .reference-section {
            flex-shrink: 0;
            text-align: center;
        }

        .reference-section h5 {
            margin-bottom: 10px;
            font-weight: bold;
        }

        .reference-image {
            max-width: 250px;
            height: auto;
            border: 2px solid #ddd;
            padding: 5px;
            background-color: white;
        }

        /* Khu v·ª±c ch∆°i game ch√≠nh */
        .main-game-section {
            text-align: center;
        }

        #timer-display {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        #game-table {
            width: 306px;
            /* 100*3 + 1*2 (borders) + 1*2 (borders) */
            height: 306px;
            margin: auto;
            /* border: 1px solid black; B·ªè vi·ªÅn ngo√†i */
            position: relative;
            overflow: hidden;
        }

        .image-cell {
            width: 100px;
            height: 100px;
            border: 1px solid #ccc;
            float: left;
            /* S·ª≠ d·ª•ng float cho l∆∞·ªõi 3x3 */
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        /* B·ªè vi·ªÅn ngo√†i c√πng c·ªßa √¥ ƒë·∫ßu ti√™n/cu·ªëi c√πng ƒë·ªÉ kh·ªõp 306px */
        /* C√≥ th·ªÉ b·ªè n·∫øu kh√¥ng qu√° quan tr·ªçng */


        /* Khu v·ª±c danh s√°ch ·∫£nh ngu·ªìn */
        #image-list-container {
            text-align: center;
            flex-basis: 100%;
            /* Lu√¥n chi·∫øm d√≤ng ri√™ng */
            order: 3;
            /* ƒê·∫£m b·∫£o n√≥ ·ªü d∆∞·ªõi */
        }

        #image-list-container h5 {
            margin-bottom: 10px;
            font-weight: bold;
        }

        #image-list {
            width: auto;
            max-width: 700px;
            min-height: 110px;
            margin: 10px auto;
            padding: 15px;
            border: 1px dashed #aaa;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: center;
            background-color: #f8f8f8;
        }

        /* √î ch·ª©a ·∫£nh trong danh s√°ch ngu·ªìn */
        #image-list .image-cell {
            float: none;
            /* Quan tr·ªçng khi d√πng flex */
            background-color: #e9e9e9;
            border-color: #bbb;
        }

        .image-cell img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: cover;
            cursor: grab;
            transition: transform 0.2s ease-in-out, opacity 0.1s linear;
        }

        .image-cell img:active {
            cursor: grabbing;
        }

        /* Tr·∫°ng th√°i chi·∫øn th·∫Øng */
        #game-table.game-won {
            border: 3px solid limegreen;
            box-shadow: 0 0 15px limegreen;
            /* ƒêi·ªÅu ch·ªânh l·∫°i k√≠ch th∆∞·ªõc ƒë·ªÉ b√π tr·ª´ cho border d√†y h∆°n */
            /* Ho·∫∑c d√πng outline thay v√¨ border */
            /* outline: 3px solid limegreen; */
            /* border: none; */
        }

        #game-table.game-won .image-cell {
            border-color: limegreen;
        }

        /* Hi·ªáu ·ª©ng k√©o th·∫£ */
        .drag-over-valid {
            background-color: #d3ffd3 !important;
            border-style: dashed !important;
        }

        .dragging {
            opacity: 0.4 !important;
            cursor: grabbing !important;
        }

        /* Khu v·ª±c ch·ªçn ·∫£nh */
        #puzzle-selection {
            text-align: center;
            clear: both;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            
        }

        #selection-list {
            align-items: center;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin: 50px;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
        }

        .puzzle-option {
            max-width: 150px;
            height: auto;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s ease, transform 0.2s ease;
            padding: 2px;
            background-color: white;
        }

        .puzzle-option:hover {
            border-color: #ddd;
            transform: scale(1.03);
        }

        .puzzle-option.active {
            border-color: limegreen;
            box-shadow: 0 0 8px limegreen;
        }

        /* --- Footer Styles --- */
        .site-footer {
            background-color: #26272b;
            /* M√†u n·ªÅn t·ªëi */
            padding: 45px 0 20px;
            /* Kho·∫£ng ƒë·ªám tr√™n d∆∞·ªõi */
            font-size: 15px;
            line-height: 24px;
            color: #737373;
            /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh */
            border-top: 2px solid #ffc107;
            /* ƒê∆∞·ªùng vi·ªÅn v√†ng tr√™n c√πng */
        }

        .site-footer .copyright-text {
            margin: 0;
            /* B·ªè margin m·∫∑c ƒë·ªãnh c·ªßa p */
            color: #a0a0a0;
            /* M√†u ch·ªØ s√°ng h∆°n m·ªôt ch√∫t */
        }

        .site-footer .footer-links a {
            color: #999;
            /* M√†u link */
            text-decoration: none;
            transition: color 0.3s ease;
            /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u */
            padding: 0 5px;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c link */
        }

        .site-footer .footer-links a:hover {
            color: #ffc107;
            /* M√†u v√†ng khi hover */
            text-decoration: none;
        }

        .site-footer .made-with {
            font-size: 0.85em;
            color: #666;
        }

        .site-footer .made-with i {
            /* Style cho tr√°i tim */
            font-style: normal;
            /* B·ªè nghi√™ng m·∫∑c ƒë·ªãnh c·ªßa i */
        }

        /* Responsive cho footer n·∫øu c·∫ßn */
        @media (max-width: 767px) {
            .site-footer {
                padding: 30px 0 15px;
            }
        }
    </style>
</head>

<body>

    <!-- ===== NAVBAR START ===== -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Game X·∫øp H√¨nh</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Trang Ch·ªß</a>
                    </li>
                    <li class="nav-item active"> <!-- Trang hi·ªán t·∫°i c√≥ class 'active' -->
                        <a class="nav-link" href="game.html">Ch∆°i Game <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">Gi·ªõi Thi·ªáu</a>
                    </li>
                    <li class="nav-item ">
                        <a class="nav-link" href="contact.html">Li√™n H·ªá </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- ===== NAVBAR END ===== -->

    <div class="game-title-area">
        <h1>Game X·∫øp H√¨nh</h1>
        <h6>Click v√†o ·∫£nh ƒë·ªÉ xoay g√≥c ƒë·ªô c·ªßa ·∫£nh. K√©o th·∫£ ·∫£nh v√†o ƒë√∫ng v·ªã tr√≠.</h6>
    </div>

    <div class="game-container">
        <!-- Khu v·ª±c ·∫£nh tham chi·∫øu b√™n tr√°i -->
        <div class="reference-section">
            <h5>·∫¢nh G·ªëc</h5>
            <!-- ·∫¢nh g·ªëc m·∫∑c ƒë·ªãnh (Paimon) -->
            <img src="AnhXepHinh/paimon/Genshin_Impact.jpg" alt="·∫¢nh g·ªëc tham kh·∫£o" class="reference-image">
        </div>

        <!-- Khu v·ª±c ch∆°i game ch√≠nh gi·ªØa -->
        <div class="main-game-section">
            <div id="timer-display">Th·ªùi gian: 00:00</div>
            <div id="game-table">
                <!-- 9 √¥ m·ª•c ti√™u 3x3 -->
                <div class="image-cell target-cell" id="cell-0" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-1" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-2" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-3" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-4" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-5" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-6" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-7" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
                <div class="image-cell target-cell" id="cell-8" ondragover="allowDrop(event, this)"
                    ondrop="receiveData(event)" ondragleave="dragLeave(event, this)"></div>
            </div>
        </div>

        <!-- Khu v·ª±c danh s√°ch ·∫£nh ngu·ªìn -->
        <div id="image-list-container">
            <h5>C√°c M·∫£nh Gh√©p</h5>
            <div id="image-list">
                <!-- C√°c √¥ ·∫£nh ngu·ªìn m·∫∑c ƒë·ªãnh (Paimon) - S·∫Ω ƒë∆∞·ª£c shuffle b·ªüi JS -->
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-1.jpg" id="paimon-image01" data-correct-cell="cell-0"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-2.jpg" id="paimon-image02" data-correct-cell="cell-1"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-3.jpg" id="paimon-image03" data-correct-cell="cell-2"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-4.jpg" id="paimon-image04" data-correct-cell="cell-3"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-5.jpg" id="paimon-image05" data-correct-cell="cell-4"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-6.jpg" id="paimon-image06" data-correct-cell="cell-5"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-7.jpg" id="paimon-image07" data-correct-cell="cell-6"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-8.jpg" id="paimon-image08" data-correct-cell="cell-7"
                        draggable="true" />
                </div>
                <div class="image-cell source-cell">
                    <img src="AnhXepHinh/paimon/anh-9.jpg" id="paimon-image09" data-correct-cell="cell-8"
                        draggable="true" />
                </div>
            </div>
        </div>

    </div><!-- End .game-container -->

    <!-- Khu v·ª±c ch·ªçn ·∫£nh m·ªõi -->
    <div id="puzzle-selection">
        <h4 style="border-top: 1px solid #eee; padding: 20px; margin-left: 50px;">Ch·ªçn ·∫¢nh Kh√°c</h4>
        <div id="selection-list">
            <!-- Danh s√°ch ·∫£nh l·ª±a ch·ªçn s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
        </div>
    </div>

    <!-- ===== FOOTER START ===== -->
    <footer class="site-footer">
        <!-- Copy y h·ªát footer t·ª´ index.html -->
        <div class="container">
           <div class="row">
               <div class="col-12 text-center">
                   <p class="copyright-text mb-2">
                       ¬© 2024 Game X·∫øp H√¨nh Vui Nh·ªôn. Ph√°t tri·ªÉn b·ªüi Tr√†n H·ªØu ƒê·∫°t.
                   </p>
                   <p class="footer-links mb-1">
                       <a href="index.html">Trang Ch·ªß</a> |
                       <a href="game.html">Ch∆°i Game</a> |
                       <a href="about.html">Gi·ªõi Thi·ªáu</a> |
                       <a href="contact.html">Li√™n H·ªá</a>
                   </p>
                   <p class="made-with">
                       <small>ƒê∆∞·ª£c x√¢y d·ª±ng v·ªõi <i class="text-danger">‚ô•</i> v√† Bootstrap, jQuery.</small>
                   </p>
               </div>
           </div>
       </div>
   </footer>
   <!-- ===== FOOTER END ===== -->

    <!-- Modal th√¥ng b√°o chi·∫øn th·∫Øng -->
    <div class="modal fade" id="winModal" tabindex="-1" role="dialog" aria-labelledby="winModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="winModalLabel">üéâ Ch√∫c M·ª´ng! üéâ</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">√ó</span>
                    </button>
                </div>
                <div class="modal-body">
                    B·∫°n ƒë√£ ho√†n th√†nh b·ª©c tranh! <br>
                    Th·ªùi gian c·ªßa b·∫°n l√†: <strong id="final-time"></strong>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="location.reload()">Ch∆°i L·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Custom Game JavaScript -->
    <script>
        // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ---
        let timerInterval = null;
        let startTime = null;
        let timerRunning = false;
        let gameWon = false;
        let draggedElement = null;
        let currentPuzzleId = 'paimon'; // B·∫Øt ƒë·∫ßu v·ªõi b·ªô 'paimon'

        // --- D·ªØ li·ªáu c√°c b·ªô ·∫£nh ---
        const puzzlesData = {
            'paimon': {
                name: 'Paimon',
                // !!! THAY ƒê·ªîI ƒê∆Ø·ªúNG D·∫™N N·∫æU C·∫¶N !!!
                reference: 'AnhXepHinh/paimon/Genshin_Impact.jpg', // V√≠ d·ª• ƒë∆∞·ªùng d·∫´n kh√°c
                pieces: [
                    'AnhXepHinh/paimon/anh-1.jpg', 'AnhXepHinh/paimon/anh-2.jpg', 'AnhXepHinh/paimon/anh-3.jpg',
                    'AnhXepHinh/paimon/anh-4.jpg', 'AnhXepHinh/paimon/anh-5.jpg', 'AnhXepHinh/paimon/anh-6.jpg',
                    'AnhXepHinh/paimon/anh-7.jpg', 'AnhXepHinh/paimon/anh-8.jpg', 'AnhXepHinh/paimon/anh-9.jpg'
                ],
                thumbnail: 'AnhXepHinh/paimon/Genshin_Impact.jpg'
            },
            'honkai_star_rail': {
                name: 'Honkai Star Rail',
                // !!! THAY ƒê·ªîI ƒê∆Ø·ªúNG D·∫™N N·∫æU C·∫¶N !!!
                reference: 'AnhXepHinh/honkai_star_rail/Honkai_Star_Rail.png', // V√≠ d·ª• ƒë∆∞·ªùng d·∫´n kh√°c
                pieces: [
                    'AnhXepHinh/honkai_star_rail/anh-1.jpg', 'AnhXepHinh/honkai_star_rail/anh-2.jpg', 'AnhXepHinh/honkai_star_rail/anh-3.jpg',
                    'AnhXepHinh/honkai_star_rail/anh-4.jpg', 'AnhXepHinh/honkai_star_rail/anh-5.jpg', 'AnhXepHinh/honkai_star_rail/anh-6.jpg',
                    'AnhXepHinh/honkai_star_rail/anh-7.jpg', 'AnhXepHinh/honkai_star_rail/anh-8.jpg', 'AnhXepHinh/honkai_star_rail/anh-9.jpg'
                ],
                thumbnail: 'AnhXepHinh/honkai_star_rail/Honkai_Star_Rail.png' // V√≠ d·ª• ƒë∆∞·ªùng d·∫´n kh√°c
            },
            'zenless_zone_zero': {
                name: 'Zenless Zone Zero',
                // !!! THAY ƒê·ªîI ƒê∆Ø·ªúNG D·∫™N N·∫æU C·∫¶N !!!
                reference: 'AnhXepHinh/zenless_zone_zero/zenless-zone-zero.jpg', // V√≠ d·ª• ƒë∆∞·ªùng d·∫´n kh√°c
                pieces: [
                    'AnhXepHinh/zenless_zone_zero/anh-1.jpg', 'AnhXepHinh/zenless_zone_zero/anh-2.jpg', 'AnhXepHinh/zenless_zone_zero/anh-3.jpg',
                    'AnhXepHinh/zenless_zone_zero/anh-4.jpg', 'AnhXepHinh/zenless_zone_zero/anh-5.jpg', 'AnhXepHinh/zenless_zone_zero/anh-6.jpg',
                    'AnhXepHinh/zenless_zone_zero/anh-7.jpg', 'AnhXepHinh/zenless_zone_zero/anh-8.jpg', 'AnhXepHinh/zenless_zone_zero/anh-9.jpg'
                ],
                thumbnail: 'AnhXepHinh/zenless_zone_zero/zenless-zone-zero.jpg' // V√≠ d·ª• ƒë∆∞·ªùng d·∫´n kh√°c
            }
            // Th√™m c√°c b·ªô ·∫£nh kh√°c v√†o ƒë√¢y
        };

        // --- C√°c h√†m x·ª≠ l√Ω th·ªùi gian ---
        function startTimer() {
            if (!timerRunning && !gameWon) {
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
                timerRunning = true;
            }
        }
        function stopTimer() {
            clearInterval(timerInterval);
            timerRunning = false;
        }
        function updateTimer() {
            if (!startTime) return;
            const elapsedTime = Date.now() - startTime;
            const seconds = Math.floor((elapsedTime / 1000) % 60);
            const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            $('#timer-display').text(`Th·ªùi gian: ${formattedTime}`);
        }
        function getFinalTime() {
            if (!startTime) return "00:00";
            const elapsedTime = Date.now() - startTime;
            const seconds = Math.floor((elapsedTime / 1000) % 60);
            const minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- H√†m ki·ªÉm tra ƒëi·ªÅu ki·ªán th·∫Øng ---
        function checkWinCondition() {
            if (gameWon) return false;
            const targetCells = $('#game-table .target-cell');
            if (targetCells.length !== 9) return false;
            let allCorrect = true;
            for (let i = 0; i < targetCells.length; i++) {
                const cell = targetCells[i];
                const img = cell.querySelector('img');
                if (!img) { allCorrect = false; break; }
                const expectedCellId = img.getAttribute('data-correct-cell');
                const currentCellId = cell.id;
                const currentAngle = ($(img).data('angle') || 0) % 360;
                if (expectedCellId !== currentCellId || currentAngle !== 0) {
                    allCorrect = false;
                    break;
                }
            }
            if (allCorrect) {
                gameWon = true;
                stopTimer();
                $('#game-table').addClass('game-won');
                $('#game-table img, #image-list img').attr('draggable', false).css('cursor', 'default');
                $('#final-time').text(getFinalTime());
                $('#winModal').modal('show');
            }
            return allCorrect;
        }

        // --- H√†m x√°o tr·ªôn ---
        function shuffleImages() {
            var parent = $("#image-list");
            var cells = parent.children('.source-cell');
            if (cells.length === 0) return;

            var tempCells = [];
            cells.each(function () {
                tempCells.push($(this).detach());
            });

            while (tempCells.length) {
                parent.append(tempCells.splice(Math.floor(Math.random() * tempCells.length), 1)[0]);
            }

            parent.find('.source-cell img').each(function () {
                var randomRotation = getRandomRotationAngle();
                $(this).css('transform', 'rotate(' + randomRotation + 'deg)');
                $(this).data('angle', randomRotation);
            });
            console.log("Shuffled images for:", currentPuzzleId);
        }

        // --- H√†m l·∫•y g√≥c xoay ng·∫´u nhi√™n ---
        function getRandomRotationAngle() {
            var angles = [0, 90, 180, 270];
            return angles[Math.floor(Math.random() * angles.length)];
        }


        // --- C√°c h√†m x·ª≠ l√Ω Drag and Drop ---
        function startDrag(event) {
            if (gameWon) { event.preventDefault(); return; }
            draggedElement = event.target;
            event.dataTransfer.setData('imageId', draggedElement.id);
            setTimeout(() => {
                if (draggedElement) draggedElement.classList.add('dragging');
            }, 0);
        }

        function allowDrop(event, receiverCell) {
            if (gameWon) return;
            const isReceiverEmpty = receiverCell.childElementCount === 0;
            const isNotSelfContainer = draggedElement ? receiverCell !== draggedElement.parentNode : true;
            if (isReceiverEmpty && isNotSelfContainer) {
                event.preventDefault();
                receiverCell.classList.add('drag-over-valid');
            }
        }

        function dragLeave(event, receiverCell) {
            if (receiverCell) receiverCell.classList.remove('drag-over-valid');
        }

        function endDrag(event) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            $('.image-cell').removeClass('drag-over-valid');
            draggedElement = null;
        }

        function receiveData(event) {
            event.preventDefault();
            if (gameWon) return;

            const id = event.dataTransfer.getData('imageId');
            const droppedImage = document.getElementById(id);
            let targetCell = event.target;

            $('.image-cell').removeClass('drag-over-valid');

            if (!droppedImage) return;

            if (targetCell.tagName === 'IMG') {
                targetCell = targetCell.parentNode;
            }

            if (targetCell.classList.contains('image-cell') &&
                targetCell.childElementCount === 0 &&
                (!draggedElement || targetCell !== draggedElement.parentNode)) {
                targetCell.appendChild(droppedImage);

                if ($(targetCell).closest('#game-table').length > 0 && !timerRunning) {
                    console.log("ƒêi·ªÅu ki·ªán b·∫Øt ƒë·∫ßu timer th·ªèa m√£n"); // Log ƒë·ªÉ ki·ªÉm tra
                    startTimer();
                }
                if ($(targetCell).closest('#game-table').length > 0) {
                    checkWinCondition();
                }
            }
            // Kh√¥ng c·∫ßn reset dragging class ·ªü ƒë√¢y v√¨ endDrag s·∫Ω x·ª≠ l√Ω
            // if(droppedImage) droppedImage.classList.remove('dragging');
            // draggedElement = null; // endDrag s·∫Ω reset
        }


        // --- H√†m t·∫°o danh s√°ch l·ª±a ch·ªçn ·∫£nh ---
        function populateSelectionList() {
            const selectionList = $('#selection-list');
            selectionList.empty();

            for (const puzzleId in puzzlesData) {
                const puzzle = puzzlesData[puzzleId];
                const imgElement = $('<img>')
                    .attr('src', puzzle.thumbnail)
                    .attr('alt', `Ch·ªçn ${puzzle.name}`)
                    .attr('data-puzzle-id', puzzleId)
                    .addClass('puzzle-option img-thumbnail')
                    .on('click', selectPuzzle); // G√°n s·ª± ki·ªán

                if (puzzleId === currentPuzzleId) {
                    imgElement.addClass('active');
                }
                selectionList.append(imgElement);
            }
        }

        // --- H√†m x·ª≠ l√Ω khi ch·ªçn b·ªô ·∫£nh m·ªõi ---
        function selectPuzzle(event) {
            const selectedId = $(event.target).data('puzzle-id');
            if (selectedId === currentPuzzleId) return;

            currentPuzzleId = selectedId;
            $('.puzzle-option').removeClass('active');
            $(event.target).addClass('active');
            resetAndLoadPuzzle(currentPuzzleId);
        }

        // --- H√†m Reset v√† T·∫£i b·ªô ·∫£nh m·ªõi ---
        function resetAndLoadPuzzle(puzzleId) {
            const puzzle = puzzlesData[puzzleId];
            if (!puzzle) { console.error("Kh√¥ng t√¨m th·∫•y b·ªô ·∫£nh:", puzzleId); return; }

            // 1. Reset game
            gameWon = false;
            stopTimer();
            startTime = null;
            timerRunning = false;
            $('#timer-display').text('Th·ªùi gian: 00:00');
            $('#game-table').removeClass('game-won');
            $('#game-table .target-cell').empty();

            // 2. Update ·∫£nh g·ªëc
            $('.reference-image').attr('src', puzzle.reference).attr('alt', `·∫¢nh g·ªëc ${puzzle.name}`);

            // 3. T·∫°o m·∫£nh gh√©p m·ªõi
            const imageList = $('#image-list');
            imageList.empty();

            if (!puzzle.pieces || puzzle.pieces.length !== 9) {
                console.error("D·ªØ li·ªáu m·∫£nh gh√©p kh√¥ng h·ª£p l·ªá cho:", puzzleId);
                imageList.html('<p style="color: red;">L·ªói t·∫£i m·∫£nh gh√©p!</p>');
                return;
            }

            puzzle.pieces.forEach((pieceSrc, index) => {
                const cellId = `cell-${index}`;
                const imgId = `${puzzleId}-image${String(index + 1).padStart(2, '0')}`;

                // T·∫°o ·∫£nh v√† l·∫•y DOM element
                const imgDOM = $('<img>')
                    .attr('src', pieceSrc)
                    .attr('id', imgId)
                    .attr('data-correct-cell', cellId)
                    .get(0); // L·∫•y DOM element

                // G√°n thu·ªôc t√≠nh v√† s·ª± ki·ªán tr·ª±c ti·∫øp
                imgDOM.draggable = true;
                imgDOM.ondragstart = startDrag;
                imgDOM.ondragend = endDrag;
                // Click listener ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi $(document).on(...)

                // T·∫°o √¥ ch·ª©a v√† l·∫•y DOM element
                const cellDOM = $('<div>')
                    .addClass('image-cell source-cell')
                    .append(imgDOM) // Th√™m ·∫£nh v√†o √¥
                    .get(0); // L·∫•y DOM element

                // G√°n s·ª± ki·ªán tr·ª±c ti·∫øp cho √¥ ch·ª©a
                cellDOM.ondragover = (e) => allowDrop(e, cellDOM);
                cellDOM.ondrop = (e) => receiveData(e);
                cellDOM.ondragleave = (e) => dragLeave(e, cellDOM);

                imageList.append(cellDOM); // Th√™m √¥ ch·ª©a v√†o list
            });

            // 4. X√°o tr·ªôn
            shuffleImages();

            // 5. K√≠ch ho·∫°t l·∫°i k√©o th·∫£
            $('#image-list img').css('cursor', 'grab'); // C·∫≠p nh·∫≠t cursor

        }

        // --- Document Ready ---
        $(document).ready(function () {
            // G√°n s·ª± ki·ªán cho c√°c ·∫£nh ban ƒë·∫ßu c√≥ trong HTML
            $('#image-list img').each(function () {
                const imgDOM = $(this).get(0);
                imgDOM.ondragstart = startDrag;
                imgDOM.ondragend = endDrag;
            });
            $('#image-list .source-cell').each(function () {
                const cellDOM = $(this).get(0);
                cellDOM.ondragover = (e) => allowDrop(e, cellDOM);
                cellDOM.ondrop = (e) => receiveData(e);
                cellDOM.ondragleave = (e) => dragLeave(e, cellDOM);
            });


            // Hi·ªÉn th·ªã danh s√°ch ch·ªçn
            populateSelectionList();

            // X√°o tr·ªôn b·ªô ·∫£nh m·∫∑c ƒë·ªãnh
            shuffleImages();
        });

        // --- S·ª∞ KI·ªÜN CLICK XOAY ·∫¢NH (D√πng event delegation) ---
        $(document).on('click', '.image-cell img', function (e) {
            if (gameWon) return;
            if ($(this).hasClass('dragging')) return; // Ki·ªÉm tra class dragging

            var currentAngle = ($(this).data('angle') || 0);
            var newAngle = (currentAngle + 90) % 360;
            $(this).css('transform', 'rotate(' + newAngle + 'deg)');
            $(this).data('angle', newAngle);

            if ($(this).closest('#game-table').length > 0) {
                checkWinCondition();
            }
        });

    </script>

</body>

</html>